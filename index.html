<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Min PWA+</title>

  <!-- Manifest + tema -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b57d0">

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="./assets/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="./assets/icon-512.png">

  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    header { padding: 16px; background: #0b57d0; color: #fff; display: flex; align-items: center; justify-content: space-between; }
    main { padding: 16px; display: grid; gap: 12px; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .card { border: 1px solid color-mix(in oklab, CanvasText 12%, transparent); border-radius: 12px; padding: 12px; }
    #updatebar { position: fixed; left: 50%; transform: translateX(-50%); bottom: 16px; background: #1f2937; color: #fff; padding: 10px 14px; border-radius: 999px; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 20px rgba(0,0,0,.25); }
    #updatebar[hidden] { display: none; }
    .muted { opacity: .7; font-size: .9em; }
  </style>
</head>
<body>
  <header>
    <h1>Min PWA+</h1>
    <div class="row">
      <button id="install" hidden>Installera</button>
      <button id="share" title="Dela">Dela</button>
      <button id="wakelock" title="Håll skärmen vaken">Skärm på</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Offline-stöd</h2>
      <p>Den här appen fungerar offline efter första laddningen. Testa: ladda sidan, slå på flygplansläge och ladda om.</p>
      <p class="muted">PWA+ inkluderar offline-sida, uppdateringsruta, och smart cache för API:er.</p>
    </section>

    <section class="card">
      <h2>API-exempel</h2>
      <p>Tryck för att hämta data (demonstration). Om du sedan går offline kommer senaste svaret att levereras från cache.</p>
      <div class="row">
        <button id="fetch">Hämta data</button>
        <span id="status" class="muted"></span>
      </div>
      <pre id="out" style="max-width:100%; overflow:auto;"></pre>
    </section>
  </main>

  <!-- Uppdateringsbar -->
  <div id="updatebar" hidden>
    Ny version finns
    <button id="reload">Uppdatera</button>
  </div>

  <script>
    // ===== Service Worker-registrering + uppdateringsflöde =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').then(reg => {
        const bar = document.getElementById('updatebar');
        const btn = document.getElementById('reload');

        function showUpdate(reg) {
          bar.hidden = false;
          btn.onclick = () => reg.waiting?.postMessage({ type: 'SKIP_WAITING' });
        }

        // 1) Waiting redan?
        if (reg.waiting) showUpdate(reg);

        // 2) Ny installerande worker
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw?.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              showUpdate(reg);
            }
          });
        });

        // 3) När kontrollern byts → ladda om
        navigator.serviceWorker.addEventListener('controllerchange', () => location.reload());
      });
    }

    // ===== Egen install-knapp (ej garanterad i iOS) =====
    let deferredPrompt;
    const installBtn = document.getElementById('install');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); deferredPrompt = e; installBtn.hidden = false;
    });
    installBtn?.addEventListener('click', async () => {
      installBtn.hidden = true;
      if (!deferredPrompt) return;
      deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null;
    });

    // ===== Web Share API =====
    document.getElementById('share').addEventListener('click', async () => {
      if (navigator.share) {
        try {
          await navigator.share({ title: document.title, text: 'Kolla min PWA+', url: location.href });
        } catch {}
      } else {
        alert('Dela stöds inte i denna webbläsare.');
      }
    });

    // ===== Wake Lock (håll skärmen vaken) =====
    let wakeLock = null;
    async function toggleWakeLock() {
      try {
        if (!('wakeLock' in navigator)) return alert('Wake Lock stöds inte.');
        if (!wakeLock) {
          wakeLock = await navigator.wakeLock.request('screen');
          document.getElementById('wakelock').textContent = 'Skärm av';
          wakeLock.addEventListener('release', () => {
            document.getElementById('wakelock').textContent = 'Skärm på';
            wakeLock = null;
          });
        } else {
          await wakeLock.release(); // triggers release event
        }
      } catch (e) {
        alert('Kunde inte aktivera Wake Lock.');
      }
    }
    document.getElementById('wakelock').addEventListener('click', toggleWakeLock);

    // ===== Demo: hämta API (cacheas i SW) =====
    const fetchBtn = document.getElementById('fetch');
    const out = document.getElementById('out');
    const statusEl = document.getElementById('status');
    fetchBtn.addEventListener('click', async () => {
      out.textContent = ''; statusEl.textContent = 'Hämtar...';
      try {
        // Publikt demo-API (cross-origin JSON); byt gärna till eget API senare
        const res = await fetch('https://jsonplaceholder.typicode.com/todos/1', { mode: 'cors' });
        const data = await res.json();
        out.textContent = JSON.stringify(data, null, 2);
        statusEl.textContent = 'OK (nät)';
      } catch {
        statusEl.textContent = 'Offline (cache om tillgängligt)';
      }
    });
  </script>
</body>
</html>
